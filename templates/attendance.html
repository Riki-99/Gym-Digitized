{% extends "searchinginterface.html" %}
{% block post_redirection %} 
/attendance
{% endblock %}

{% block search_title %}
    Search for Attendance:
{% endblock %}

{% block customizedTable%}  
<h3>{{records}}</h3>
<table class="table table-striped">
            <thead class="table-dark">
                <tr>
                        <th>Member ID the fuck</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Mobile Number</th>
                        <th>Permanent Address</th>
                </tr>
            </thead>
            <tbody class="table-light">
                <h3>Show date for gods sake{{ datetoday }}</h3>
                {% for record in records %}        
                        <td><a href="/fetch_data?member_id={{record['persons.person_id']}}">{{record["person_id"]}}</a></td>
                        <td><a href="/fetch_data?member_id={{record['person_id']}}">{{record["first_name"]}}</a></td>
                        <td><a href="/fetch_data?member_id={{record['person_id']}}">{{record["last_name"]}}</a></td>
                        <td><a href="/fetch_data?member_id={{record['person_id']}}">{{record["mobile_number"]}}</a></td>
                        <td><a href="/fetch_data?member_id={{record['person_id']}}">{{record["permanent_address"]}}</a></td>
                        <td>{% if record["todaysrecord"] %}
                            Todays record : record["todaysrecord"]
                            Present stuff
                            <!-- Using data-id in order to store the id so it is convenient to access from js -->
                            <button class="absentMarker" data-id="{{record['person_id']}}">Mark Absent</button>
                        {% else %}
                            <button class="presentMarker" data-id="{{record['person_id']}}">Mark Present</button>                          
                        {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>    
    </table>
    <script>    
        // Adding js to send request to the backend to mark a dude present
        presentMarkers = document.querySelectorAll(".presentMarker");
        presentMarkers.forEach((element) => {
            element.addEventListener("click", async ()=>{
                let markingRequest = await fetch("/mark_present", {
                    method:"POST",
                    headers: {
                        "Content-Type" : "application/json"
                    },
                    // We use stringify to convert the json format into dictionary format in python
                    body: JSON.stringify({
                        // data-xyz is accessed as element.dataset.xyz
                        id : element.dataset.id
                    })
                })
                // The response needs to be converted into JSON in order to be understood by js.
                let response = await markingRequest.json()
                console.log(response)
            })
        });

        absentMarkers = document.querySelectorAll(".absentMarker");
        absentMarkers.forEach((element) =>{
            element.addEventListener("click", async () =>{
                let data = await fetch("/mark_absent", {
                    method: "POST",
                    headers: {
                        "Content-Type" : "application/json"
                    },
                    body: JSON.stringify({
                        id : element.dataset.id
                    })
                })
                let response = await data.json()
                console.log(response)
            })
        })

    </script>
{% endblock %}


