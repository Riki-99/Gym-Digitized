{% extends "template.html" %}
{% block body %}
        <form action="/transaction_review" method="post">
        <div class="mb-3">
            <h2>Transaction Details</h2>
        </div>
        <div class="mb-3">
            <label for="cashFlowDirection" class="form-label"> Transaction Direction: </label>
            <select id="cashFlowDirection" name = "cash_flow_direction" class="form-select">
                <option value=1>Income</option>
                <option value=0>Expense</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="amount" class="form-label">Transaction Amount (Rs): </label>
            <input type="number" class="form-control" id="amount" name = "transaction_amount" value="{{loading_amount}}"required>
        </div>

        <div class="mb-3">
            <label for="transactionCategory" class="form-label"> Transaction Category: </label>
            <select id="transactionCategory" name = "transaction_category" class="form-select">
                {% for trans_cat in transaction_categories %}
                    <option value='{{trans_cat["id"]}}' class='category{{trans_cat["direction"]}}'>{{trans_cat["name"]}}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <button type="button" id="transactionCategoryKey" class="btn btn-primary mb-3 d-flex align-items-center gap-5 black-button">Add a new transaction category</button>
        </div>
        <div class="mb-3" id="newTransactionCategoryDiv" style="display:none; border: solid #333 2px; border-radius: 3px; padding: 1%;">
            <label for="newTransactionCategory" class="form-label">New Transaction Category: </label>
            <input type="text" class="form-control" id="newTransactionCategory" name = "new_transaction_category" placeholder="Add a new transaction category...">

            <div class="mb-3">
            <label for="newCashFlowDirection"> Cashflow Direction: </label>
                <select id="newCashFlowDirection" name = "new_cash_flow_direction" class="form-select">
                    <option value=1>Income</option>
                    <option value=0>Expense</option>
                </select>
            </div>

            <button id="newTransactionCategoryAdder" type="button" class="btn btn-primary mb-3 d-flex align-items-center gap-5 black-button">Add</button>
        </div>

        <div class="mb-3">
            <label for="secondParty" class="form-label"> Transaction Other Party: </label>
            <select id="secondParty" name = "second_party" class="form-select">
                <option value=0 {% if default_party == 0 %} selected {% endif %}>Member</option>
                <option value=1 {% if default_party == 1 %} selected {% endif %}>Staff</option>
                <option value=2 {% if default_party == 2 %} selected {% endif %}>External</option>
            </select>
        </div>

        <div class="mb-3" id="personIdDiv">
            <label for="person_id" class="form-label">Transacting Person ID: </label>
            <input type="number" class="form-control" id="personId" name = "person_id" value="{{default_person_id}}">
        </div>

        <div class="mb-3">
            <label for="remarks" class="form-label">Remarks: </label>
            <textarea class="form-control" id="remarks" name = "transaction_remarks" placeholder="Remarks" required value="{{default_remarks}}"></textarea>
        </div>
        <button type="submit" class="btn btn-primary mb-3 d-flex align-items-center gap-5">CONFIRM</button>
    </form> 

    <script>
        let newTransactionCategoryExpanded = false;
        document.querySelector("#cashFlowDirection").addEventListener("change", transactionCategorySelector);
        // Flag for selecting the first option by default to prevent previous invalid opetion from remaining selected
        function transactionCategorySelector(){
            firsttime = true;
            direction = document.querySelector("#cashFlowDirection").value;
            console.log("Direction: ", direction)
            incomeCategories = document.querySelectorAll(".category1");
            expenseCategories = document.querySelectorAll(".category0");
            if(direction == 1)
            {
                console.log(1)
                // This means that direction = 1 and we're looking for income categories
                expenseCategories.forEach(element => {
                    element.style.display = "none";
                    element.removeAttribute("selected");
                });

                incomeCategories.forEach((element) => {
                    element.style.display = "block";
                    if(firsttime)
                    {
                        element.setAttribute("selected", "true");
                        firsttime = false;
                    }
                });
            }
            else{
                console.log(0)
                incomeCategories.forEach(element => {
                    element.style.display = "none";
                    element.removeAttribute("selected");
                });

                expenseCategories.forEach((element) => {
                    element.style.display = "block";
                    if(firsttime)
                    {
                        element.setAttribute("selected", "true");
                        firsttime = false;
                    }
                });
            }
        }
        // Call the function once for initial configuration
        transactionCategorySelector();

        // For expanding and collpasing the "Add new transaction category"
        let keyButton = document.querySelector("#transactionCategoryKey");
        keyButton.addEventListener("click", () =>{
            relevantDiv = document.querySelector("#newTransactionCategoryDiv");
            if(newTransactionCategoryExpanded)
            {
                relevantDiv.style.display = "none";
                document.querySelector("#personId").value = ""
                keyButton.innerText = "Add a new transaction category"
                newTransactionCategoryExpanded = false;
            }
            else{
                relevantDiv.style.display = "block";
                keyButton.innerText = "Collapse"
                newTransactionCategoryExpanded = true;
            }
        })

        // For actually adding the new transaction category to the database
        document.querySelector("#newTransactionCategoryAdder").addEventListener("click", async ()=>{
            Cname = document.querySelector("#newTransactionCategory").value.trim();
            if(name.value == "")
            {
                alert("ERROR : Please name the new transaction category");
                return;
            }
            Cdirection = parseInt(document.querySelector('#newCashFlowDirection').value);
            let data = await fetch("/new_transaction_category", {
                "method" : "POST",
                "headers" : {"Content-Type" : "application/JSON"},
                "body": JSON.stringify({name : Cname, direction : Cdirection})
            })
            let response = await data.json()
            console.log(response)
        })

        // For stuff regarding the other party
        otherParty = document.querySelector("#secondParty");
        otherParty.addEventListener("change", dealWithPersonId)

        function dealWithPersonId(){
            // If not external, we need a new field to manually enter the person id
            personIdDiv = document.querySelector("#personIdDiv");
            if(otherParty.value != 2)
            {
                personIdDiv.style.display = "block";
            }
            else{
                 personIdDiv.style.display = "none";
            }
        }
        document.body.addEventListener("load", dealWithPersonId);
    </script>
{% endblock %}